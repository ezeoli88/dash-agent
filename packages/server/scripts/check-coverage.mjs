/**
 * Per-file coverage gate script.
 *
 * Reads the json-summary produced by vitest and enforces minimum line-coverage
 * thresholds on mature files.  agent.service.ts is intentionally excluded —
 * target date to incorporate: post Fase D.
 *
 * Usage:  node scripts/check-coverage.mjs
 * Expects: coverage/coverage-summary.json (generated by vitest --coverage)
 */

import { readFileSync } from 'node:fs';
import { resolve, dirname } from 'node:path';
import { fileURLToPath } from 'node:url';

const __dirname = dirname(fileURLToPath(import.meta.url));

// Thresholds: file suffix → minimum lines %
const FILE_THRESHOLDS = {
  'routes/tasks.ts': 70,
  'services/task.service.ts': 70,
  'services/git.service.ts': 70,
  'services/repo.service.ts': 90,
};

const summaryPath = resolve(__dirname, '..', 'coverage', 'coverage-summary.json');

let summary;
try {
  summary = JSON.parse(readFileSync(summaryPath, 'utf-8'));
} catch {
  console.error(`\u274c Could not read ${summaryPath}`);
  console.error('   Run "vitest run --coverage" first to generate the report.');
  process.exit(1);
}

let failed = false;

for (const [suffix, threshold] of Object.entries(FILE_THRESHOLDS)) {
  // Find the key in summary that ends with the suffix
  const key = Object.keys(summary).find((k) => k.replace(/\\/g, '/').endsWith(suffix));

  if (!key) {
    console.error(`\u274c ${suffix}: not found in coverage report (file renamed/deleted?)`);
    failed = true;
    continue;
  }

  const pct = summary[key].lines.pct;

  if (pct < threshold) {
    console.error(`\u274c ${suffix}: ${pct.toFixed(2)}% lines < ${threshold}% required`);
    failed = true;
  } else {
    console.log(`\u2705 ${suffix}: ${pct.toFixed(2)}% lines (>= ${threshold}%)`);
  }
}

if (failed) {
  console.error('\nPer-file coverage gates FAILED.');
  process.exit(1);
} else {
  console.log('\nAll per-file coverage gates passed.');
}
