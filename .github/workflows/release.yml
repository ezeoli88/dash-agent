name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Build all packages
        run: npm run build

      - name: Build binaries for all platforms
        run: |
          mkdir -p dist/linux-x64 dist/macos-x64 dist/macos-arm64 dist/win-x64

          bun build packages/server/src/bin.ts --compile --target=bun-linux-x64 \
            --outfile dist/linux-x64/agent-board

          bun build packages/server/src/bin.ts --compile --target=bun-darwin-x64 \
            --outfile dist/macos-x64/agent-board

          bun build packages/server/src/bin.ts --compile --target=bun-darwin-arm64 \
            --outfile dist/macos-arm64/agent-board

          bun build packages/server/src/bin.ts --compile --target=bun-windows-x64 \
            --outfile dist/win-x64/agent-board.exe

      - name: Copy frontend assets and WASM to each platform directory
        run: |
          for plat in linux-x64 macos-x64 macos-arm64 win-x64; do
            cp -r packages/dashboard/dist dist/$plat/public
            cp node_modules/sql.js/dist/sql-wasm.wasm dist/$plat/
          done

      - name: Create platform ZIPs
        run: |
          cd dist/linux-x64 && zip -r ../linux-x64.zip . && cd ../..
          cd dist/macos-x64 && zip -r ../macos-x64.zip . && cd ../..
          cd dist/macos-arm64 && zip -r ../macos-arm64.zip . && cd ../..
          cd dist/win-x64 && zip -r ../win-x64.zip . && cd ../..

      - name: Generate manifest.json
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          LINUX_X64_SHA=$(sha256sum dist/linux-x64.zip | awk '{print $1}')
          MACOS_X64_SHA=$(sha256sum dist/macos-x64.zip | awk '{print $1}')
          MACOS_ARM64_SHA=$(sha256sum dist/macos-arm64.zip | awk '{print $1}')
          WIN_X64_SHA=$(sha256sum dist/win-x64.zip | awk '{print $1}')

          printf '%s\n' \
            '{' \
            "  \"version\": \"${VERSION}\"," \
            '  "platforms": {' \
            "    \"linux-x64\": { \"zip\": \"linux-x64/agent-board.zip\", \"sha256\": \"${LINUX_X64_SHA}\" }," \
            "    \"macos-x64\": { \"zip\": \"macos-x64/agent-board.zip\", \"sha256\": \"${MACOS_X64_SHA}\" }," \
            "    \"macos-arm64\": { \"zip\": \"macos-arm64/agent-board.zip\", \"sha256\": \"${MACOS_ARM64_SHA}\" }," \
            "    \"win-x64\": { \"zip\": \"win-x64/agent-board.zip\", \"sha256\": \"${WIN_X64_SHA}\" }" \
            '  }' \
            '}' > dist/manifest.json

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-artifacts
          path: |
            dist/*.zip
            dist/manifest.json

  upload-r2:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-artifacts
          path: dist

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Install rclone
        run: |
          curl -O https://downloads.rclone.org/rclone-current-linux-amd64.deb
          sudo dpkg -i rclone-current-linux-amd64.deb

      - name: Configure rclone for R2
        run: |
          rclone config create r2 s3 \
            provider=Cloudflare \
            access_key_id=${{ secrets.R2_ACCESS_KEY_ID }} \
            secret_access_key=${{ secrets.R2_SECRET_ACCESS_KEY }} \
            endpoint=https://${{ secrets.R2_ACCOUNT_ID }}.r2.cloudflarestorage.com \
            acl=private

      - name: Upload binaries to R2
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          rclone copy dist/manifest.json "r2:${BUCKET}/binaries/v${VERSION}/"
          rclone copyto dist/linux-x64.zip "r2:${BUCKET}/binaries/v${VERSION}/linux-x64/agent-board.zip"
          rclone copyto dist/macos-x64.zip "r2:${BUCKET}/binaries/v${VERSION}/macos-x64/agent-board.zip"
          rclone copyto dist/macos-arm64.zip "r2:${BUCKET}/binaries/v${VERSION}/macos-arm64/agent-board.zip"
          rclone copyto dist/win-x64.zip "r2:${BUCKET}/binaries/v${VERSION}/win-x64/agent-board.zip"

      - name: Upload latest.json
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
          BUCKET: ${{ secrets.R2_BUCKET_NAME }}
        run: |
          echo "{\"tag\":\"v${VERSION}\",\"version\":\"${VERSION}\"}" > latest.json
          rclone copyto latest.json "r2:${BUCKET}/latest.json"

  publish-npm:
    needs: upload-r2
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install latest npm (OIDC requires >= 11.5.1)
        run: npm install -g npm@latest

      - name: Publish CLI package
        run: cd packages/cli && npm publish --provenance --access public
